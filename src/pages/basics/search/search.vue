<template>
  <view>
    <cu-custom
      bg-color="bg-white"
      :is-back="true"
    >
      <view
        slot="content"
        class="text-black"
      >
        语记·搜索
      </view>
    </cu-custom>
    <scroll-view
      scroll-y
      class="scrollPage"
    >
      <view
        v-if="index == 2"
        class="bg-white padding-sm padding-left"
      >
        <view class="text-black text-bold text-xl">
          输入汉字查拼音
        </view>
        <view>忽略所有非汉字字符，暂不支持搜索繁体字</view>
      </view>
      <view class="cu-bar search bg-white">
        <view class="action">
          <picker
            :value="index"
            :range="sort"
            @change="sortFun"
          >
            <text>{{ sort[index] }}</text>
            <text class="cuIcon-triangledownfill" />
          </picker>
        </view>
        <view class="search-form round">
          <text class="cuIcon-search" />
          <input
            type="text"
            placeholder="兴化语记"
            :focus="true"
            :value="key"
            confirm-type="search"
            @input="keyFun"
            @confirm="search"
          >
        </view>
        <view
          class="action"
          @tap="search"
        >
          <text class="text-blue">
            搜索
          </text>
        </view>
      </view>
      <!-- <view class="cu-bar bg-white text-grey" wx:if="{{status==0}}">
    <view class="action">历史搜索</view>
    <image src="/images/home/delete.png" mode="widthFix" bindtap="deleteHistory"
      style="width:5vw;height:auto;margin-right:30rpx;">
    </image>
  </view> -->
      <!-- <view class="history" wx:if="{{status==0}}">
    <view class="padding-xs" wx:for="{{history}}">
      <view class="cu-tag round">{{item}}</view>
    </view>
  </view> -->
      <!-- <view class="bg-white flex text-df text-black" wx:if="{{status!=0}}">
    <view class="flex-sub padding {{status==1?'text-bold':''}}" bindtap="sort" data-index="1">单字</view>
    <view class="flex-sub padding {{status==2?'text-bold':''}}" bindtap="sort" data-index="2">词语</view>
    <view class="flex-sub padding line {{status==3?'text-bold':''}}" bindtap="sort" data-index="3">文章</view>
    <view class="flex-sub padding text-center" bindtap="sort" data-index="3">更多</view>
  </view> -->
      <view
        v-if="index == 0 && status == 1"
        class="cu-list menu"
      >
        <view
          v-for="(item, index1) in words"
          :key="index1"
          class="cu-item arrow "
          style="min-height: 240rpx;border-bottom: 1upx solid rgba(0, 0, 0, 0.07);"
          :data-index="index1"
          @tap="word"
        >
          <view class="flex flex-direction justify-between">
            <view class="margin-bottom-xs">
              <text class="text-xxl text-bold">
                {{ item.word.word }}
              </text>
            </view>
            <view class="margin-bottom-xs">
              <text>{{ item.word.standard_pinyin }}</text>
              <text class="text-grey padding-left">
                /{{ item.word.standard_ipa }}/
              </text>
              <text
                v-if="item.pronunciation.url.length > 4"
                class="cuIcon-notificationfill text-blue margin-left"
              />
            </view>
            <view class="text-grey definition">
              {{ item.word.definition }}
            </view>
          </view>
        </view>
      </view>
      <view v-if="index == 1 && status == 1">
        <view
          v-for="(item, index11) in pronunciation"
          :key="index11"
          class="cu-list menu"
        >
          <view
            v-for="(kid, index1) in item.characters"
            :key="index1"
            class="cu-item arrow"
            style="min-height: 150rpx"
            :data-id="kid.characters[0].id"
            @tap="character"
          >
            <view class="flex flex-direction justify-between">
              <view class="margin-bottom-sm margin-top-sm">
                <text class="text-xxl text-bold">
                  {{ item.label }}
                </text>
                <!-- <text class="cuIcon-notificationfill text-blue margin-left"></text> -->
              </view>
              <view class="text-lg flex flex-wrap margin-bottom-sm">
                <view
                  v-for="(k, index2) in kid.characters"
                  :key="index2"
                  class="margin-right-xl"
                >
                  <text>{{ k.pinyin }}</text>
                  <text class="text-grey margin-left">
                    /{{ k.ipa }}/
                  </text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view
        v-if="index == 2 && status == 1"
        class="bg-white"
      >
        <view
          v-for="(i, index11) in characters"
          :key="index11"
        >
          <view
            v-for="(j, index1) in i.characters"
            :key="index1"
            class="padding solid-bottom"
          >
            <view>
              <text class="text-xxl text-black text-bold">
                {{ i.label }}
              </text>
              <text v-if="i.lable !== i.traditional" />
              <text class="text-xl">
                {{ i.label === i.traditional ? ' ' : i.traditional }}
              </text>
              <text class="text-grey">
                {{ j.county }} / {{ j.town }}
              </text>
            </view>
            <view class="text-lg margin-top-xs flex flex-wrap">
              <view
                v-for="(k, index2) in j.characters"
                :key="index2"
                :data-id="k.word"
                style="display: flex;width: 50%;"
                @tap="getWord"
              >
                <view
                  v-if="k.word"
                  class="text-blue"
                  space="emsp"
                  style="width: 40%;"
                >
                  {{ k.pinyin }}
                </view>
                <view
                  v-else
                  space="emsp"
                  style="width: 40%;"
                >
                  {{ k.pinyin }}
                </view>
                <view
                  class="text-grey"
                  space="emsp"
                  style="width: 60%;"
                >
                  /{{ k.ipa }}/
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view v-if="index == 3 && status == 1">
        <ArticleList
          v-if="articles.length !== 0"
          :article-list="articles"
        />
      </view>
    </scroll-view>
  </view>
</template>

<script>
import {searchCharacters} from "@/services/character";
import {getWords, searchWords} from "@/services/word";
import {searchArticle} from "@/services/article";
import ArticleList from "@/components/ArticleList";

const app = getApp();
export default {
  components: {
    ArticleList
  },
  data() {
    return {
      status: 0,
      index: 0,
      sort: ['词语', '单字', '拼音', '文章'],
      history: [],
      key: '',
      characters: [],
      pronunciation: [],
      words: [],
      articles: [],
      //
      // kid: {
      //     id: '',
      //     pinyin: '',
      //     ipa: ''
      // },
      //
      // i: {
      //     characters: [],
      //     label: '',
      //     lable: '',
      //     traditional: ''
      // },
      //
      // j: {
      //     county: '',
      //     town: '',
      //     characters: []
      // },
      //
      // k: {
      //     word: '',
      //     pinyin: '',
      //     ipa: ''
      // }
    };
  },
  onLoad(option) {
    if (option.index) {
      this.index = option.index
    }
    let history = uni.getStorageSync('history');
    if (history) {
      this.history = history
    }
  },
  /**
   * 右上角分享事件
   */
  onShareAppMessage() {
    return {
      title: '语记·搜索',
      path: `/pages/component/search/search`,
      success: () => {
        uni.showToast({
          title: '分享成功',
          icon: 'success',
          duration: 2000
        });
      },
      fail: () => {
        uni.showToast({
          title: '分享失败',
          icon: 'none',
          duration: 2000
        });
      }
    };
  },
  methods: {
    sortFun(e) {
      this.index = e.detail.value
    },

    keyFun(e) {
      this.key = e.detail.value
    },

    search() {
      if (this.key == '') {
        uni.showModal({
          content: '搜索内容为空！',
          showCancel: false
        });
        return;
      }
      this.status = 1;
      this.history.push(this.key);
      uni.setStorageSync('history', this.history);
      let key = this.key;
      let index = this.index;
      if (index == 0) {
        // 词语
        this.searchWord(key);
      } else if (index == 1) {
        // 单字 多字
        this.searchCharacter(key);
      } else if (index == 2) {
        // 拼音
        this.searchPinyin(key);
      } else if (index == 3) {
        // 文章
        this.searchArticleList(key);
      }
    },

    /**
     * 搜索拼音
     * @returns {Promise<void>}
     */
    async searchPinyin(key) {
      await searchCharacters(key).then(async (res) => {
        if (res.characters.length === 0) {
          uni.showToast({
            title: '搜索结果为空',
            icon: 'none'
          });
        } else {
          this.characters = res.characters
        }
      })
    },
    /**
     * 搜索单字
     * @returns {Promise<void>}
     */
    async searchCharacter(key) {
      await searchCharacters(key).then(async (res) => {
        if (res.characters.length === 0) {
          uni.showToast({
            title: '搜索结果为空',
            icon: 'none'
          });
        } else {
          this.pronunciation = res.characters
        }
      })
    },

    /**
     * 搜索词语
     * @returns {Promise<void>}
     */
    async searchWord(key) {
      const res      = await searchWords(key)
      const wordsId  = res.words
      await getWords(wordsId).then(async (res1) => {
        if (res1.words.length === 0) {
          uni.showToast({
            title: '搜索结果为空',
            icon: 'none'
          });
        } else {
          this.words = res1.words;
        }
      })
    },

    /**
     * 搜索文章
     * @returns {Promise<void>}
     */
    async searchArticleList(key) {
      await searchArticle(key).then(async (res) => {
        if (res.length === 0) {
          uni.showToast({
            title: '搜索结果为空',
            icon: 'none'
          });
        } else {
          this.articles = res;
        }
      })
    },

    deleteHistory() {
      let that = this;
      uni.showModal({
        title: '提示',
        content: '是否清空历史记录？',

        success(res) {
          uni.setStorageSync('history', null);
          that.setData({
            history: []
          });
        }
      });
    },

    character(e) {
      let id = e.currentTarget.dataset.id;
      uni.navigateTo({
        url: '/pages/basics/characters/characters?id=' + id
      });
    },

    word(e) {
      let index = e.currentTarget.dataset.index;
      let id = this.words[index].word.id;
      uni.navigateTo({
        url: '/pages/basics/words/words?id=' + id
      });
    },

    toArticle(e) {
      let id = e.currentTarget.dataset.id;
      uni.navigateTo({
        url: '/pages/plugin/article/article?id=' + id
      });
    },

    getWord(e) {
      let id = e.currentTarget.dataset.id;

      if (!id) {
        return;
      }

      uni.navigateTo({
        url: '/pages/basics/words/words?id=' + id
      });
    }
  }
};
</script>
<style>
.history {
  padding: 0 20rpx 20rpx 20rpx;
  display: flex;
  flex-wrap: wrap;
  background-color: white;
}

.line {
  position: relative;
}

.line::after {
  content: ' ';
  width: 200%;
  height: 90%;
  position: absolute;
  top: 30%;
  left: 0;
  border-radius: inherit;
  transform: scale(0.5);
  transform-origin: 0 0;
  pointer-events: none;
  box-sizing: border-box;
  border-right: 1rpx solid rgba(0, 0, 0, 0.5);
}

.definition {
  display: -webkit-box;
  word-break: break-all;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>
